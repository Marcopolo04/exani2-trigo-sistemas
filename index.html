<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Exani II - M√∫ltiples Ex√°menes</title>
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
            font-weight: normal;
        }

        .exam-selector {
            background: linear-gradient(135deg, #6c5ce7 0%, #a363d9 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .exam-selector h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .exam-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .exam-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .exam-btn:hover {
            background: white;
            color: #6c5ce7;
        }

        .exam-btn.active {
            background: white;
            color: #6c5ce7;
            border-color: #6c5ce7;
        }

        .student-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .student-info h3 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .student-info input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        .student-info input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .attempts-box {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .attempts-box h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .attempts-box .attempt-count {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .timer {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
        }

        .question {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background-color: #667eea;
            color: white;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .question-status {
            background-color: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover:not(.disabled):not(.answered) {
            background-color: #e8f0fe;
            border-color: #667eea;
        }

        .option input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .option.selected {
            background-color: #e8f0fe;
            border-color: #667eea;
        }

        .option.correct-answer {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .option.incorrect-answer {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .option.answered {
            cursor: not-allowed;
            opacity: 0.9;
        }

        .option.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e9ecef;
        }

        .feedback-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .feedback-correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .feedback-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #7f8c8d;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .result-item {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: left;
        }

        .result-label {
            font-weight: bold;
            color: #667eea;
        }

        .download-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            margin: 10px;
        }

        .saving-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 2000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .instructions {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .exam-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
        }

        .answered-badge {
            background-color: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .student-info {
                padding: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            button {
                padding: 10px 20px;
                font-size: 14px;
            }

            .exam-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="saving-indicator" id="savingIndicator">‚úì Procesando...</div>

    <div class="container">
        <h1>üìö Simulador Exani II</h1>
        <h2>M√∫ltiples Ex√°menes de Pr√°ctica</h2>
        
        <div class="exam-selector">
            <h3>üìå Selecciona el examen que deseas practicar:</h3>
            <div class="exam-buttons">
                <button class="exam-btn active" onclick="selectExam(0)" id="exam0">üìê Examen 1: Trigonometr√≠a y Sistemas</button>
                <button class="exam-btn" onclick="selectExam(1)" id="exam1">üî¢ Examen 2: Productos Notables y Factorizaci√≥n</button>
            </div>
        </div>
        
        <div class="student-info" id="registrationForm">
            <h3>üìã Registro del Estudiante</h3>
            <input type="text" id="studentName" placeholder="Nombre completo del estudiante" required>
            <input type="email" id="studentEmail" placeholder="Correo electr√≥nico" required>
            <button class="btn-success" onclick="registerStudent()" style="width: 100%;">Comenzar Simulacro</button>
        </div>

        <div id="examContent" style="display: none;">
            <div class="exam-title" id="examTitle">Examen 1: Trigonometr√≠a y Sistemas de Ecuaciones</div>
            
            <div class="attempts-box" id="attemptsBox">
                <h3>üéØ Intento #<span id="currentAttempt">1</span> de 3</h3>
                <div class="attempt-count" id="attemptsLeft">3</div>
                <p>Intentos restantes para completar el examen</p>
            </div>

            <div class="timer" id="timer">01:00:00</div>

            <div class="instructions" id="attemptInstructions">
                <strong>üìå Instrucciones:</strong> Tienes UNA SOLA OPORTUNIDAD por pregunta. 
                Al seleccionar una respuesta, ver√°s inmediatamente si es correcta o incorrecta.
                Las preguntas incorrectas mostrar√°n la respuesta correcta.
            </div>

            <div class="progress-bar">
                <div class="progress" id="progress" style="width: 0%"></div>
            </div>

            <div id="questionsContainer"></div>

            <div class="buttons">
                <button class="btn-secondary" onclick="prevQuestion()" id="prevBtn" disabled>‚óÄ Anterior</button>
                <button class="btn-primary" onclick="nextQuestion()" id="nextBtn">Siguiente ‚ñ∂</button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="finishAttempt()" style="flex: 2;" id="finishBtn">‚úÖ Finalizar este Intento</button>
                <button class="btn-warning" onclick="showHistory()" style="flex: 1;" id="historyBtn">üìä Ver mi historial</button>
            </div>
        </div>
    </div>

    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">Resultados del Intento #<span id="modalAttemptNumber"></span></h2>
            <div id="resultsContent"></div>
            <button class="btn-primary download-btn" onclick="downloadResults()">üì• Descargar Resultados</button>
            <button class="btn-secondary" onclick="closeModal()">Cerrar</button>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h2 style="color: #333; margin-bottom: 20px;">üìä Historial de Intentos</h2>
            <div id="historyContent"></div>
            <button class="btn-secondary" onclick="closeHistoryModal()">Cerrar</button>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURACI√ìN DE EMAILJS - TUS DATOS
        // =============================================
        const EMAIL_CONFIG = {
            serviceId: 'service_6svkub7',
            templateId: 'template_fq667qa',
            userId: 'I9nGobBxGUrKY2k16',
            teacherEmail: 'servicioseducativosoxford@gmail.com'
        };

        // Inicializar EmailJS con tu Public Key
        emailjs.init(EMAIL_CONFIG.userId);
        // =============================================

        // =============================================
        // EX√ÅMENES DISPONIBLES
        // =============================================
        const exams = [
            // =============================================
// EX√ÅMENES DISPONIBLES - CON 3 EX√ÅMENES
// =============================================
    const exams = [
    // EXAMEN 1 - TRIGONOMETR√çA Y SISTEMAS
    {
        name: "Examen 1: Trigonometr√≠a y Sistemas de Ecuaciones",
        description: "Trigonometr√≠a, Sistemas 2x2 y Sistemas 3x3",
        questions: [
            // Primera pregunta (para abreviar, mant√©n tus preguntas originales aqu√≠)
            {
                text: "¬øCu√°l es el valor de sen(30¬∞)?",
                options: ["1/2", "‚àö3/2", "‚àö2/2"],
                correct: 0,
                topic: "Trigonometr√≠a",
                explanation: "El seno de 30¬∞ es 1/2"
            }
            // ... (aqu√≠ van todas tus otras preguntas del examen 1)
        ]
    },
    
    // EXAMEN 2 - PRODUCTOS NOTABLES Y FACTORIZACI√ìN
    {
        name: "Examen 2: Productos Notables, Factorizaci√≥n y √Ålgebra de Funciones",
        description: "Productos Notables, Factorizaci√≥n y √Ålgebra de Funciones",
        questions: [
            // Primera pregunta (para abreviar, mant√©n tus preguntas originales aqu√≠)
            {
                text: "¬øCu√°l es el resultado de (a + b)¬≤?",
                options: ["a¬≤ + 2ab + b¬≤", "a¬≤ - 2ab + b¬≤", "a¬≤ + b¬≤"],
                correct: 0,
                topic: "Productos Notables",
                explanation: "El cuadrado de un binomio suma es: (a+b)¬≤ = a¬≤ + 2ab + b¬≤"
            }
            // ... (aqu√≠ van todas tus otras preguntas del examen 2)
        ]
    },
    
    // EXAMEN 3 - PROBABILIDAD Y ESTAD√çSTICA (NUEVO)
    {
        name: "Examen 3: Probabilidad y Estad√≠stica",
        description: "Probabilidad, Estad√≠stica descriptiva",
        questions: [
            {
                text: "¬øCu√°l es la probabilidad de obtener un n√∫mero par al lanzar un dado?",
                options: ["1/2", "1/3", "1/6"],
                correct: 0,
                topic: "Probabilidad B√°sica",
                explanation: "Los n√∫meros pares son 2,4,6: 3/6 = 1/2"
            },
            {
                text: "Si se lanza una moneda 3 veces, ¬øprobabilidad de 3 √°guilas?",
                options: ["1/8", "1/4", "1/2"],
                correct: 0,
                topic: "Probabilidad B√°sica",
                explanation: "(1/2)¬≥ = 1/8"
            },
            {
                text: "En una baraja de 52 cartas, ¬øprobabilidad de sacar un as?",
                options: ["1/13", "1/52", "4/13"],
                correct: 0,
                topic: "Probabilidad B√°sica",
                explanation: "4 ases de 52: 4/52 = 1/13"
            },
            {
                text: "Datos: 2, 4, 6, 8, 10. ¬øCu√°l es la media?",
                options: ["6", "5", "7"],
                correct: 0,
                topic: "Estad√≠stica",
                explanation: "(2+4+6+8+10)/5 = 30/5 = 6"
            },
            {
                text: "¬øCu√°l es la mediana de: 3, 5, 7, 9, 11?",
                options: ["7", "5", "9"],
                correct: 0,
                topic: "Estad√≠stica",
                explanation: "El valor central es 7"
            },
            {
                text: "Datos: 2, 2, 3, 4, 4, 4, 5. ¬øCu√°l es la moda?",
                options: ["4", "2", "3"],
                correct: 0,
                topic: "Estad√≠stica",
                explanation: "El 4 aparece 3 veces"
            },
            {
                text: "¬øCu√°ntas permutaciones de 3 elementos en un conjunto de 5?",
                options: ["60", "20", "10"],
                correct: 0,
                topic: "Combinatoria",
                explanation: "P(5,3) = 5!/2! = 60"
            },
            {
                text: "¬øCu√°ntas combinaciones de 2 elementos en un conjunto de 4?",
                options: ["6", "12", "4"],
                correct: 0,
                topic: "Combinatoria",
                explanation: "C(4,2) = 6"
            },
            {
                text: "Si P(A) = 0.5, P(B) = 0.4, P(A‚à©B) = 0.2, ¬øP(A|B)?",
                options: ["0.5", "0.4", "0.2"],
                correct: 0,
                topic: "Probabilidad Condicional",
                explanation: "P(A|B) = 0.2/0.4 = 0.5"
            },
            {
                text: "En un grupo de 30 estudiantes, 18 mujeres. ¬øProbabilidad de elegir hombre?",
                options: ["0.4", "0.6", "0.3"],
                correct: 0,
                topic: "Probabilidad",
                explanation: "Hombres: 12, Total: 30, 12/30 = 0.4"
            }
        ]
    }
];
        // Estado de la aplicaci√≥n
        let currentExam = 0; // 0 para examen 1, 1 para examen 2
        let currentStudent = {
            name: '',
            email: '',
            attempts: [], // Guardar√° intentos por examen
            currentAttempt: 1,
            maxAttempts: 3
        };

        let currentQuestion = 0;
        let answers = [];
        let questionStatus = []; // 'correct', 'incorrect', 'pending'
        let timer;
        let timeLeft = 3600;
        let examFinished = false;
        let attemptStartTime;

        function selectExam(examIndex) {
            currentExam = examIndex;
            
            // Actualizar botones
            document.getElementById('exam0').classList.remove('active');
            document.getElementById('exam1').classList.remove('active');
            document.getElementById(`exam${examIndex}`).classList.add('active');
            
            document.getElementById('examTitle').textContent = exams[examIndex].name;
            
            // Si ya hay un estudiante registrado, resetear para nuevo examen
            if (currentStudent.name) {
                if (confirm('¬øCambiar de examen? Se perder√° el progreso del examen actual.')) {
                    resetForNewExam();
                }
            }
        }

        function resetForNewExam() {
            // Resetear estado del examen
            const examKey = `student_${currentStudent.email}_exam${currentExam}`;
            const stored = localStorage.getItem(examKey);
            
            if (stored) {
                currentStudent.attempts = JSON.parse(stored).attempts || [];
            } else {
                currentStudent.attempts = [];
            }
            
            currentStudent.currentAttempt = currentStudent.attempts.length + 1;
            
            // Ocultar contenido del examen si est√° visible
            document.getElementById('examContent').style.display = 'none';
            document.getElementById('registrationForm').style.display = 'block';
        }

        function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();

            if (!name || !email) {
                alert('Por favor, ingresa tu nombre y correo electr√≥nico');
                return;
            }

            if (!email.includes('@') || !email.includes('.')) {
                alert('Por favor, ingresa un correo electr√≥nico v√°lido');
                return;
            }

            // Cargar historial del estudiante para este examen espec√≠fico
            const examKey = `student_${email}_exam${currentExam}`;
            const stored = localStorage.getItem(examKey);
            
            if (stored) {
                currentStudent = JSON.parse(stored);
            } else {
                currentStudent = {
                    name: name,
                    email: email,
                    attempts: [],
                    currentAttempt: 1,
                    maxAttempts: 3
                };
            }

            // Verificar si puede intentar
            if (currentStudent.attempts.length >= 3) {
                alert(`Ya has completado los 3 intentos para ${exams[currentExam].name}. No puedes realizar m√°s intentos.`);
                return;
            }

            currentStudent.currentAttempt = currentStudent.attempts.length + 1;
            
            // Guardar en localStorage
            localStorage.setItem(examKey, JSON.stringify(currentStudent));

            // Mostrar examen
            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('examContent').style.display = 'block';
            
            // Actualizar UI
            updateAttemptsDisplay();
            
            // Iniciar nuevo intento
            resetAttempt();
            startTimer();
            renderQuestions();
        }

        function resetAttempt() {
            const exam = exams[currentExam];
            answers = new Array(exam.questions.length).fill(null);
            questionStatus = new Array(exam.questions.length).fill('pending');
            currentQuestion = 0;
            timeLeft = 3600;
            examFinished = false;
            attemptStartTime = new Date();
            
            if (currentQuestion < exam.questions.length) {
                document.querySelectorAll('.question').forEach(q => q.style.display = 'none');
                const firstQuestion = document.getElementById('q0');
                if (firstQuestion) firstQuestion.style.display = 'block';
            }
            
            updateNavigationButtons();
            updateProgress();
            updateAttemptsDisplay();
        }

        function updateAttemptsDisplay() {
            document.getElementById('currentAttempt').textContent = currentStudent.currentAttempt;
            document.getElementById('attemptsLeft').textContent = 3 - currentStudent.attempts.length;
            
            const attemptsBox = document.getElementById('attemptsBox');
            if (currentStudent.attempts.length >= 2) {
                attemptsBox.style.background = 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)';
            } else if (currentStudent.attempts.length >= 1) {
                attemptsBox.style.background = 'linear-gradient(135deg, #f39c12 0%, #e67e22 100%)';
            } else {
                attemptsBox.style.background = 'linear-gradient(135deg, #f39c12 0%, #f1c40f 100%)';
            }
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                if (!examFinished) {
                    timeLeft--;
                    updateTimerDisplay();
                    
                    if (timeLeft <= 0) {
                        finishAttempt();
                    }
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            const exam = exams[currentExam];
            
            exam.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.id = `q${index}`;
                questionDiv.style.display = index === 0 ? 'block' : 'none';
                
                const isAnswered = questionStatus[index] !== 'pending';
                
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Pregunta ${index + 1} - ${q.topic}</div>
                        ${isAnswered ? 
                            `<div class="answered-badge">${questionStatus[index] === 'correct' ? '‚úì Correcta' : '‚úó Incorrecta'}</div>` : 
                            `<div class="question-status">Esperando respuesta</div>`}
                    </div>
                    <div class="question-text">${index + 1}. ${q.text}</div>
                    <div class="options" id="options-${index}">
                        ${q.options.map((opt, optIndex) => {
                            const isSelected = answers[index] === optIndex;
                            const isCorrect = optIndex === q.correct;
                            let optionClass = 'option';
                            
                            if (isAnswered) {
                                if (isCorrect) {
                                    optionClass += ' correct-answer';
                                } else if (isSelected && !isCorrect) {
                                    optionClass += ' incorrect-answer';
                                }
                                optionClass += ' answered';
                            } else if (isSelected) {
                                optionClass += ' selected';
                            }
                            
                            return `
                                <label class="${optionClass}">
                                    <input type="radio" name="q${index}" value="${optIndex}" 
                                        ${isSelected ? 'checked' : ''} 
                                        ${isAnswered ? 'disabled' : ''}
                                        onchange="handleAnswer(${index}, ${optIndex})">
                                    ${String.fromCharCode(65 + optIndex)}. ${opt}
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <div id="feedback-${index}" class="feedback-message">
                        ${isAnswered && questionStatus[index] === 'incorrect' ? 
                            `<div class="feedback-incorrect">‚ùå Incorrecto. La respuesta correcta es ${String.fromCharCode(65 + q.correct)}. ${q.explanation || ''}</div>` : 
                            isAnswered && questionStatus[index] === 'correct' ?
                            `<div class="feedback-correct">‚úì ¬°Correcto! ${q.explanation || ''}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(questionDiv);
            });
        }

        function handleAnswer(questionIndex, optionIndex) {
            // Si ya respondi√≥, no permitir cambiar
            if (questionStatus[questionIndex] !== 'pending' || examFinished) {
                return;
            }

            const exam = exams[currentExam];
            const isCorrect = optionIndex === exam.questions[questionIndex].correct;
            
            // Guardar respuesta
            answers[questionIndex] = optionIndex;
            
            if (isCorrect) {
                questionStatus[questionIndex] = 'correct';
            } else {
                questionStatus[questionIndex] = 'incorrect';
            }
            
            // Actualizar la interfaz de la pregunta actual
            updateQuestionDisplay(questionIndex);
            updateProgress();
        }

        function updateQuestionDisplay(questionIndex) {
            const questionDiv = document.getElementById(`q${questionIndex}`);
            const exam = exams[currentExam];
            const q = exam.questions[questionIndex];
            
            // Actualizar header
            const header = questionDiv.querySelector('.question-header');
            const answeredBadge = questionStatus[questionIndex] === 'correct' ? 
                '<div class="answered-badge">‚úì Correcta</div>' : 
                '<div class="answered-badge">‚úó Incorrecta</div>';
            
            header.innerHTML = `
                <div class="question-number">Pregunta ${questionIndex + 1} - ${q.topic}</div>
                ${answeredBadge}
            `;
            
            // Actualizar opciones
            const optionsContainer = document.getElementById(`options-${questionIndex}`);
            const labels = optionsContainer.querySelectorAll('.option');
            labels.forEach((label, idx) => {
                const radio = label.querySelector('input');
                const isSelected = answers[questionIndex] === idx;
                const isCorrect = idx === q.correct;
                
                label.classList.remove('correct-answer', 'incorrect-answer', 'selected', 'answered');
                
                if (isCorrect) {
                    label.classList.add('correct-answer');
                } else if (isSelected && !isCorrect) {
                    label.classList.add('incorrect-answer');
                }
                
                label.classList.add('answered');
                radio.disabled = true;
            });
            
            // Actualizar feedback
            const feedbackDiv = document.getElementById(`feedback-${questionIndex}`);
            if (questionStatus[questionIndex] === 'incorrect') {
                feedbackDiv.innerHTML = `<div class="feedback-incorrect">‚ùå Incorrecto. La respuesta correcta es ${String.fromCharCode(65 + q.correct)}. ${q.explanation || ''}</div>`;
            } else {
                feedbackDiv.innerHTML = `<div class="feedback-correct">‚úì ¬°Correcto! ${q.explanation || ''}</div>`;
            }
        }

        function nextQuestion() {
            const exam = exams[currentExam];
            if (currentQuestion < exam.questions.length - 1) {
                document.getElementById(`q${currentQuestion}`).style.display = 'none';
                currentQuestion++;
                document.getElementById(`q${currentQuestion}`).style.display = 'block';
                updateNavigationButtons();
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                document.getElementById(`q${currentQuestion}`).style.display = 'none';
                currentQuestion--;
                document.getElementById(`q${currentQuestion}`).style.display = 'block';
                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            const exam = exams[currentExam];
            document.getElementById('prevBtn').disabled = currentQuestion === 0;
            document.getElementById('nextBtn').disabled = currentQuestion === exam.questions.length - 1;
        }

        function updateProgress() {
            const answered = questionStatus.filter(s => s !== 'pending').length;
            const exam = exams[currentExam];
            const progress = (answered / exam.questions.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }

        function calculateResults() {
            const exam = exams[currentExam];
            let correct = 0;
            let incorrect = 0;
            let unanswered = 0;
            
            const topicResults = {};

            exam.questions.forEach((q, index) => {
                if (!topicResults[q.topic]) {
                    topicResults[q.topic] = { total: 0, correct: 0 };
                }
                
                topicResults[q.topic].total++;
                
                if (questionStatus[index] === 'correct') {
                    correct++;
                    topicResults[q.topic].correct++;
                } else if (questionStatus[index] === 'incorrect') {
                    incorrect++;
                } else {
                    unanswered++;
                }
            });

            return { correct, incorrect, unanswered, topicResults };
        }

        async function finishAttempt() {
            examFinished = true;
            clearInterval(timer);
            
            const exam = exams[currentExam];
            const results = calculateResults();
            const totalScore = (results.correct / exam.questions.length * 100).toFixed(1);
            
            // Guardar este intento
            const attemptData = {
                examName: exam.name,
                attemptNumber: currentStudent.currentAttempt,
                date: new Date().toLocaleString(),
                timeUsed: formatTime(3600 - timeLeft),
                results: results,
                totalScore: totalScore,
                answers: [...answers],
                questionStatus: [...questionStatus]
            };
            
            currentStudent.attempts.push(attemptData);
            
            // Guardar en localStorage espec√≠fico para este examen
            const examKey = `student_${currentStudent.email}_exam${currentExam}`;
            localStorage.setItem(examKey, JSON.stringify(currentStudent));
            
            // Enviar por email
            await sendResultsByEmail(attemptData);
            
            // Mostrar resultados
            showAttemptResults(attemptData);
        }

        async function sendResultsByEmail(attemptData) {
            const indicator = document.getElementById('savingIndicator');
            indicator.style.display = 'block';
            indicator.textContent = 'üìß Enviando resultados al profesor...';
            indicator.style.backgroundColor = '#3498db';

            try {
                // Preparar los par√°metros para la plantilla
                const templateParams = {
                    student_name: currentStudent.name,
                    student_email: currentStudent.email,
                    exam_name: exams[currentExam].name,
                    date: attemptData.date,
                    attempt_number: attemptData.attemptNumber,
                    time_used: attemptData.timeUsed,
                    score: attemptData.totalScore,
                    correct: attemptData.results.correct,
                    incorrect: attemptData.results.incorrect,
                    unanswered: attemptData.results.unanswered
                };

                // A√±adir resultados por tema
                let topicDetails = '';
                for (const [topic, data] of Object.entries(attemptData.results.topicResults)) {
                    topicDetails += `${topic}: ${data.correct}/${data.total} (${(data.correct/data.total*100).toFixed(1)}%)\n`;
                }
                templateParams.topic_details = topicDetails;

                console.log('üìß Enviando correo con par√°metros:', templateParams);

                // Enviar el correo usando EmailJS
                const response = await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templateId,
                    templateParams
                );

                console.log('‚úÖ Respuesta de EmailJS:', response);
                
                indicator.textContent = '‚úì Resultados enviados al profesor correctamente';
                indicator.style.backgroundColor = '#27ae60';
                
            } catch (error) {
                console.error('‚ùå Error al enviar por email:', error);
                indicator.textContent = '‚úó Error al enviar. Guardando copia local...';
                indicator.style.backgroundColor = '#e74c3c';
                
                // Guardar copia local como respaldo
                saveLocalCopy(attemptData);
            }
            
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }

        function saveLocalCopy(attemptData) {
            const results = {
                examen: exams[currentExam].name,
                estudiante: currentStudent.name,
                email: currentStudent.email,
                intento: attemptData.attemptNumber,
                fecha: attemptData.date,
                puntaje: attemptData.totalScore + '%',
                correctas: attemptData.results.correct,
                incorrectas: attemptData.results.incorrect,
                sin_responder: attemptData.results.unanswered
            };
            
            // Guardar en localStorage como respaldo
            const backupKey = `backup_${currentStudent.email}_exam${currentExam}_${Date.now()}`;
            localStorage.setItem(backupKey, JSON.stringify(results));
            
            console.log('üì¶ Copia de seguridad guardada:', backupKey);
        }

        function showAttemptResults(attemptData) {
            document.getElementById('modalAttemptNumber').textContent = attemptData.attemptNumber;
            
            const resultsContent = document.getElementById('resultsContent');
            
            let topicHtml = '';
            for (const [topic, data] of Object.entries(attemptData.results.topicResults)) {
                topicHtml += `
                    <div class="result-item">
                        <span class="result-label">${topic}:</span> 
                        ${data.correct}/${data.total} (${(data.correct/data.total*100).toFixed(1)}%)
                    </div>
                `;
            }
            
            resultsContent.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Examen:</span> ${exams[currentExam].name}
                </div>
                <div class="result-item">
                    <span class="result-label">Estudiante:</span> ${currentStudent.name}
                </div>
                <div class="result-item">
                    <span class="result-label">Email:</span> ${currentStudent.email}
                </div>
                <div class="result-item">
                    <span class="result-label">Fecha:</span> ${attemptData.date}
                </div>
                <div class="result-item">
                    <span class="result-label">Tiempo utilizado:</span> ${attemptData.timeUsed}
                </div>
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                    <h3 style="margin-bottom: 10px;">Puntuaci√≥n Total</h3>
                    <div style="font-size: 48px; font-weight: bold;">${attemptData.totalScore}%</div>
                    <div>${attemptData.results.correct} correctas | ${attemptData.results.incorrect} incorrectas | ${attemptData.results.unanswered} sin responder</div>
                </div>
                <div style="margin: 20px 0;">
                    <h3>Desglose por tema:</h3>
                    ${topicHtml}
                </div>
            `;
            
            document.getElementById('resultsModal').style.display = 'flex';
        }

        function showHistory() {
            const historyContent = document.getElementById('historyContent');
            
            if (currentStudent.attempts.length === 0) {
                historyContent.innerHTML = '<p>No hay intentos previos para este examen.</p>';
            } else {
                historyContent.innerHTML = currentStudent.attempts.map((attempt, index) => `
                    <div class="result-item" style="border-left: 5px solid ${attempt.totalScore >= 60 ? '#27ae60' : '#e74c3c'};">
                        <h4>Intento #${attempt.attemptNumber} - ${attempt.date}</h4>
                        <p><strong>Examen:</strong> ${attempt.examName}</p>
                        <p><strong>Puntuaci√≥n:</strong> ${attempt.totalScore}%</p>
                        <p><strong>Correctas:</strong> ${attempt.results.correct}/${exams[currentExam].questions.length}</p>
                        <p><strong>Tiempo:</strong> ${attempt.timeUsed}</p>
                        <button class="btn-primary" onclick="viewAttemptDetails(${index})" style="margin-top: 10px; padding: 5px 15px;">Ver detalles</button>
                    </div>
                `).join('');
            }
            
            document.getElementById('historyModal').style.display = 'flex';
        }

        function viewAttemptDetails(attemptIndex) {
            closeHistoryModal();
            const attemptData = currentStudent.attempts[attemptIndex];
            
            document.getElementById('modalAttemptNumber').textContent = attemptData.attemptNumber;
            
            const resultsContent = document.getElementById('resultsContent');
            
            let topicHtml = '';
            for (const [topic, data] of Object.entries(attemptData.results.topicResults)) {
                topicHtml += `
                    <div class="result-item">
                        <span class="result-label">${topic}:</span> 
                        ${data.correct}/${data.total} (${(data.correct/data.total*100).toFixed(1)}%)
                    </div>
                `;
            }
            
            resultsContent.innerHTML = `
                <div class="result-item">
                    <span class="result-label">Examen:</span> ${attemptData.examName}
                </div>
                <div class="result-item">
                    <span class="result-label">Estudiante:</span> ${currentStudent.name}
                </div>
                <div class="result-item">
                    <span class="result-label">Email:</span> ${currentStudent.email}
                </div>
                <div class="result-item">
                    <span class="result-label">Fecha:</span> ${attemptData.date}
                </div>
                <div class="result-item">
                    <span class="result-label">Tiempo utilizado:</span> ${attemptData.timeUsed}
                </div>
                <div style="margin: 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 10px;">
                    <h3 style="margin-bottom: 10px;">Puntuaci√≥n Total</h3>
                    <div style="font-size: 48px; font-weight: bold;">${attemptData.totalScore}%</div>
                    <div>${attemptData.results.correct} correctas | ${attemptData.results.incorrect} incorrectas | ${attemptData.results.unanswered} sin responder</div>
                </div>
                <div style="margin: 20px 0;">
                    <h3>Desglose por tema:</h3>
                    ${topicHtml}
                </div>
            `;
            
            document.getElementById('resultsModal').style.display = 'flex';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function closeModal() {
            document.getElementById('resultsModal').style.display = 'none';
            
            // Verificar si quedan intentos
            if (currentStudent.attempts.length >= 3) {
                alert(`Has completado los 3 intentos para ${exams[currentExam].name}. Gracias por participar.`);
                // Volver al registro
                document.getElementById('examContent').style.display = 'none';
                document.getElementById('registrationForm').style.display = 'block';
            } else {
                if (confirm(`¬øQuieres intentarlo de nuevo? Te quedan ${3 - currentStudent.attempts.length} intentos.`)) {
                    currentStudent.currentAttempt = currentStudent.attempts.length + 1;
                    const examKey = `student_${currentStudent.email}_exam${currentExam}`;
                    localStorage.setItem(examKey, JSON.stringify(currentStudent));
                    resetAttempt();
                    startTimer();
                    renderQuestions();
                    updateAttemptsDisplay();
                }
            }
        }

        function downloadResults() {
            const attemptData = currentStudent.attempts[currentStudent.attempts.length - 1];
            const exam = exams[currentExam];
            
            let content = `RESULTADOS SIMULACRO EXANI II\n`;
            content += `===============================\n\n`;
            content += `Examen: ${exam.name}\n`;
            content += `Estudiante: ${currentStudent.name}\n`;
            content += `Email: ${currentStudent.email}\n`;
            content += `Intento: ${attemptData.attemptNumber}/3\n`;
            content += `Fecha: ${attemptData.date}\n`;
            content += `Tiempo utilizado: ${attemptData.timeUsed}\n\n`;
            
            content += `Puntuaci√≥n total: ${attemptData.totalScore}%\n`;
            content += `Respuestas correctas: ${attemptData.results.correct}\n`;
            content += `Respuestas incorrectas: ${attemptData.results.incorrect}\n`;
            content += `Sin responder: ${attemptData.results.unanswered}\n\n`;
            
            content += `DESGLOSE POR TEMA\n`;
            content += `-----------------\n`;
            for (const [topic, data] of Object.entries(attemptData.results.topicResults)) {
                content += `${topic}: ${data.correct}/${data.total} (${(data.correct/data.total*100).toFixed(1)}%)\n`;
            }
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resultados_${exam.name}_${currentStudent.name}_intento${attemptData.attemptNumber}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>




