<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador Exani II - 3 Ex√°menes</title>
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        h2 {
            color: #666;
            text-align: center;
            margin-bottom: 30px;
            font-size: 18px;
            font-weight: normal;
        }

        .exam-selector {
            background: linear-gradient(135deg, #6c5ce7 0%, #a363d9 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .exam-selector h3 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .exam-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .exam-btn {
            flex: 1;
            min-width: 200px;
            padding: 15px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .exam-btn:hover {
            background: white;
            color: #6c5ce7;
        }

        .exam-btn.active {
            background: white;
            color: #6c5ce7;
            border-color: #6c5ce7;
        }

        .student-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            color: white;
        }

        .student-info h3 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .student-info input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
        }

        .student-info input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        .attempts-box {
            background: linear-gradient(135deg, #f39c12 0%, #f1c40f 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }

        .attempts-box h3 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .attempts-box .attempt-count {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .timer {
            text-align: center;
            font-size: 32px;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e74c3c;
        }

        .question {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #667eea;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .question-number {
            background-color: #667eea;
            color: white;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
        }

        .question-status {
            background-color: #3498db;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .answered-badge {
            background-color: #27ae60;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 14px;
        }

        .question-text {
            font-size: 16px;
            margin-bottom: 15px;
            color: #333;
            font-weight: 500;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option {
            display: flex;
            align-items: center;
            padding: 12px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover:not(.answered) {
            background-color: #e8f0fe;
            border-color: #667eea;
        }

        .option input[type="radio"] {
            margin-right: 15px;
            transform: scale(1.2);
        }

        .option.selected {
            background-color: #e8f0fe;
            border-color: #667eea;
        }

        .option.correct-answer {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .option.incorrect-answer {
            background-color: #f8d7da;
            border-color: #dc3545;
        }

        .option.answered {
            cursor: not-allowed;
        }

        .feedback-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            text-align: center;
        }

        .feedback-correct {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .feedback-incorrect {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .progress-bar {
            width: 100%;
            height: 15px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background-color: #7f8c8d;
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            text-align: center;
            max-height: 80vh;
            overflow-y: auto;
        }

        .result-item {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: left;
        }

        .result-label {
            font-weight: bold;
            color: #667eea;
        }

        .download-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            margin: 10px;
        }

        .saving-indicator {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            font-weight: bold;
            z-index: 2000;
            animation: slideIn 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .instructions {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .exam-title {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 10px;
        }

        @media (max-width: 768px) {
            .exam-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="saving-indicator" id="savingIndicator">‚úì Procesando...</div>

    <div class="container">
        <h1>üìö Simulador Exani II</h1>
        <h2>3 Ex√°menes de Pr√°ctica</h2>
        
        <div class="exam-selector">
            <h3>üìå Selecciona el examen:</h3>
            <div class="exam-buttons">
                <button class="exam-btn active" onclick="selectExam(0)" id="exam0">üìê Examen 1: Trigonometr√≠a</button>
                <button class="exam-btn" onclick="selectExam(1)" id="exam1">üî¢ Examen 2: Productos Notables</button>
                <button class="exam-btn" onclick="selectExam(2)" id="exam2">üìä Examen 3: Probabilidad</button>
            </div>
        </div>
        
        <div class="student-info" id="registrationForm">
            <h3>üìã Registro del Estudiante</h3>
            <input type="text" id="studentName" placeholder="Nombre completo" required>
            <input type="email" id="studentEmail" placeholder="Correo electr√≥nico" required>
            <button class="btn-success" onclick="registerStudent()" style="width: 100%;">Comenzar</button>
        </div>

        <div id="examContent" style="display: none;">
            <div class="exam-title" id="examTitle">Examen 1: Trigonometr√≠a</div>
            
            <div class="attempts-box" id="attemptsBox">
                <h3>üéØ Intento #<span id="currentAttempt">1</span> de 3</h3>
                <div class="attempt-count" id="attemptsLeft">3</div>
                <p>Intentos restantes</p>
            </div>

            <div class="timer" id="timer">01:00:00</div>

            <div class="instructions">
                <strong>üìå Una sola oportunidad por pregunta.</strong> 
                Al responder ver√°s la respuesta correcta.
            </div>

            <div class="progress-bar">
                <div class="progress" id="progress" style="width: 0%"></div>
            </div>

            <div id="questionsContainer"></div>

            <div class="buttons">
                <button class="btn-secondary" onclick="prevQuestion()" id="prevBtn" disabled>‚óÄ Anterior</button>
                <button class="btn-primary" onclick="nextQuestion()" id="nextBtn">Siguiente ‚ñ∂</button>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn-success" onclick="finishAttempt()" style="flex: 2;">‚úÖ Finalizar</button>
                <button class="btn-warning" onclick="showHistory()" style="flex: 1;">üìä Historial</button>
            </div>
        </div>
    </div>

    <div class="modal" id="resultsModal">
        <div class="modal-content">
            <h2>Resultados Intento #<span id="modalAttemptNumber"></span></h2>
            <div id="resultsContent"></div>
            <button class="btn-primary download-btn" onclick="downloadResults()">üì• Descargar</button>
            <button class="btn-secondary" onclick="closeModal()">Cerrar</button>
        </div>
    </div>

    <div class="modal" id="historyModal">
        <div class="modal-content">
            <h2>üìä Historial</h2>
            <div id="historyContent"></div>
            <button class="btn-secondary" onclick="closeHistoryModal()">Cerrar</button>
        </div>
    </div>

    <script>
        // =============================================
        // TU CONFIGURACI√ìN DE EMAILJS
        // =============================================
        const EMAIL_CONFIG = {
            serviceId: 'service_6svkub7',
            templateId: 'template_fq667qa',
            userId: 'I9nGobBxGUrKY2k16',
            teacherEmail: 'servicioseducativosoxford@gmail.com'
        };
        emailjs.init(EMAIL_CONFIG.userId);

        // =============================================
        // LOS 3 EX√ÅMENES COMPLETOS
        // =============================================
        const exams = [
            // EXAMEN 1: TRIGONOMETR√çA (10 preguntas)
            {
                name: "Examen 1: Trigonometr√≠a",
                questions: [
                    {
                        text: "¬øCu√°l es el valor de sen(30¬∞)?",
                        options: ["1/2", "‚àö3/2", "‚àö2/2"],
                        correct: 0,
                        topic: "Trigonometr√≠a",
                        explanation: "El seno de 30¬∞ es 1/2"
                    },
                    {
                        text: "¬øCu√°l es el valor de cos(60¬∞)?",
                        options: ["1/2", "‚àö3/2", "‚àö2/2"],
                        correct: 0,
                        topic: "Trigonometr√≠a",
                        explanation: "El coseno de 60¬∞ es 1/2"
                    },
                    {
                        text: "¬øCu√°l es el valor de tan(45¬∞)?",
                        options: ["0", "1", "‚àö3"],
                        correct: 1,
                        topic: "Trigonometr√≠a",
                        explanation: "tan(45¬∞) = 1"
                    },
                    {
                        text: "¬øCu√°l es el valor de sen(90¬∞)?",
                        options: ["0", "1", "No definido"],
                        correct: 1,
                        topic: "Trigonometr√≠a",
                        explanation: "sen(90¬∞) = 1"
                    },
                    {
                        text: "¬øCu√°l es el valor de cos(0¬∞)?",
                        options: ["0", "1", "-1"],
                        correct: 1,
                        topic: "Trigonometr√≠a",
                        explanation: "cos(0¬∞) = 1"
                    },
                    {
                        text: "Resuelve: x + y = 5, x - y = 1",
                        options: ["x=3,y=2", "x=2,y=3", "x=4,y=1"],
                        correct: 0,
                        topic: "Sistemas",
                        explanation: "Sumando: 2x=6 ‚Üí x=3, y=2"
                    },
                    {
                        text: "Resuelve: 2x + y = 7, x - y = 2",
                        options: ["x=3,y=1", "x=2,y=3", "x=4,y=-1"],
                        correct: 0,
                        topic: "Sistemas",
                        explanation: "Sumando: 3x=9 ‚Üí x=3, y=1"
                    },
                    {
                        text: "Resuelve: x + y + z = 6, x - y + z = 2",
                        options: ["x=2,y=2,z=2", "x=3,y=2,z=1", "x=1,y=3,z=2"],
                        correct: 0,
                        topic: "Sistemas 3x3",
                        explanation: "La soluci√≥n es x=2, y=2, z=2"
                    },
                    {
                        text: "Resuelve: x + y = 5, y + z = 7, x + z = 6",
                        options: ["x=2,y=3,z=4", "x=3,y=2,z=5", "x=4,y=1,z=6"],
                        correct: 0,
                        topic: "Sistemas 3x3",
                        explanation: "Sumando: 2(x+y+z)=18 ‚Üí x+y+z=9, luego x=2,y=3,z=4"
                    },
                    {
                        text: "En un tri√°ngulo rect√°ngulo, cateto opuesto=3, hipotenusa=5, ¬øcoseno?",
                        options: ["4/5", "3/5", "5/3"],
                        correct: 0,
                        topic: "Trigonometr√≠a",
                        explanation: "Cateto adyacente=4, cos=4/5"
                    }
                ]
            },
            
            // EXAMEN 2: PRODUCTOS NOTABLES (10 preguntas)
            {
                name: "Examen 2: Productos Notables",
                questions: [
                    {
                        text: "¬ø(a + b)¬≤?",
                        options: ["a¬≤+2ab+b¬≤", "a¬≤-2ab+b¬≤", "a¬≤+b¬≤"],
                        correct: 0,
                        topic: "Productos Notables",
                        explanation: "(a+b)¬≤ = a¬≤+2ab+b¬≤"
                    },
                    {
                        text: "¬ø(a - b)¬≤?",
                        options: ["a¬≤-2ab+b¬≤", "a¬≤+2ab+b¬≤", "a¬≤-b¬≤"],
                        correct: 0,
                        topic: "Productos Notables",
                        explanation: "(a-b)¬≤ = a¬≤-2ab+b¬≤"
                    },
                    {
                        text: "¬ø(a + b)(a - b)?",
                        options: ["a¬≤-b¬≤", "a¬≤+b¬≤", "a¬≤+2ab+b¬≤"],
                        correct: 0,
                        topic: "Productos Notables",
                        explanation: "Diferencia de cuadrados: a¬≤-b¬≤"
                    },
                    {
                        text: "¬ø(x + 3)(x - 3)?",
                        options: ["x¬≤-9", "x¬≤+9", "x¬≤-6x+9"],
                        correct: 0,
                        topic: "Productos Notables",
                        explanation: "x¬≤-9"
                    },
                    {
                        text: "¬ø(2x + 1)¬≤?",
                        options: ["4x¬≤+4x+1", "4x¬≤+2x+1", "4x¬≤+1"],
                        correct: 0,
                        topic: "Productos Notables",
                        explanation: "4x¬≤+4x+1"
                    },
                    {
                        text: "Factoriza: x¬≤ - 9",
                        options: ["(x-3)(x+3)", "(x-3)¬≤", "(x+3)¬≤"],
                        correct: 0,
                        topic: "Factorizaci√≥n",
                        explanation: "Diferencia de cuadrados"
                    },
                    {
                        text: "Factoriza: x¬≤ + 6x + 9",
                        options: ["(x+3)¬≤", "(x-3)¬≤", "(x+3)(x-3)"],
                        correct: 0,
                        topic: "Factorizaci√≥n",
                        explanation: "Trinomio cuadrado perfecto"
                    },
                    {
                        text: "Factoriza: x¬≤ + 5x + 6",
                        options: ["(x+2)(x+3)", "(x+1)(x+6)", "(x+5)(x+1)"],
                        correct: 0,
                        topic: "Factorizaci√≥n",
                        explanation: "2√ó3=6, 2+3=5"
                    },
                    {
                        text: "Si f(x)=2x+3, ¬øf(2)?",
                        options: ["7", "5", "4"],
                        correct: 0,
                        topic: "Funciones",
                        explanation: "2(2)+3=7"
                    },
                    {
                        text: "Si f(x)=x¬≤-2x, ¬øf(3)?",
                        options: ["3", "6", "9"],
                        correct: 0,
                        topic: "Funciones",
                        explanation: "9-6=3"
                    }
                ]
            },
            
            // EXAMEN 3: PROBABILIDAD (10 preguntas) - NUEVO
            {
                name: "Examen 3: Probabilidad",
                questions: [
                    {
                        text: "¬øProbabilidad de n√∫mero par en un dado?",
                        options: ["1/2", "1/3", "1/6"],
                        correct: 0,
                        topic: "Probabilidad",
                        explanation: "Pares: 2,4,6 ‚Üí 3/6 = 1/2"
                    },
                    {
                        text: "¬øProbabilidad de 3 √°guilas en 3 monedas?",
                        options: ["1/8", "1/4", "1/2"],
                        correct: 0,
                        topic: "Probabilidad",
                        explanation: "(1/2)¬≥ = 1/8"
                    },
                    {
                        text: "¬øProbabilidad de sacar un as de 52 cartas?",
                        options: ["1/13", "1/52", "4/13"],
                        correct: 0,
                        topic: "Probabilidad",
                        explanation: "4 ases/52 = 1/13"
                    },
                    {
                        text: "Datos: 2,4,6,8,10. ¬øMedia?",
                        options: ["6", "5", "7"],
                        correct: 0,
                        topic: "Estad√≠stica",
                        explanation: "(2+4+6+8+10)/5 = 6"
                    },
                    {
                        text: "Datos: 3,5,7,9,11. ¬øMediana?",
                        options: ["7", "5", "9"],
                        correct: 0,
                        topic: "Estad√≠stica",
                        explanation: "Valor central = 7"
                    },
                    {
                        text: "¬øModa de 2,2,3,4,4,4,5?",
                        options: ["4", "2", "3"],
                        correct: 0,
                        topic: "Estad√≠stica",
                        explanation: "El 4 aparece 3 veces"
                    },
                    {
                        text: "¬øP(5,3) permutaciones?",
                        options: ["60", "20", "10"],
                        correct: 0,
                        topic: "Combinatoria",
                        explanation: "5√ó4√ó3 = 60"
                    },
                    {
                        text: "¬øC(4,2) combinaciones?",
                        options: ["6", "12", "4"],
                        correct: 0,
                        topic: "Combinatoria",
                        explanation: "6 formas de elegir 2 de 4"
                    },
                    {
                        text: "Si P(A)=0.5, P(B)=0.4, P(A‚à©B)=0.2, ¬øP(A|B)?",
                        options: ["0.5", "0.4", "0.2"],
                        correct: 0,
                        topic: "Probabilidad",
                        explanation: "0.2/0.4 = 0.5"
                    },
                    {
                        text: "30 estudiantes, 18 mujeres. ¬øP(hombre)?",
                        options: ["0.4", "0.6", "0.3"],
                        correct: 0,
                        topic: "Probabilidad",
                        explanation: "12/30 = 0.4"
                    }
                ]
            }
        ];

        // Estado de la aplicaci√≥n
        let currentExam = 0;
        let currentStudent = {
            name: '',
            email: '',
            attempts: [],
            currentAttempt: 1,
            maxAttempts: 3
        };

        let currentQuestion = 0;
        let answers = [];
        let questionStatus = [];
        let timer;
        let timeLeft = 3600;
        let examFinished = false;

        function selectExam(examIndex) {
            currentExam = examIndex;
            document.getElementById('exam0').classList.remove('active');
            document.getElementById('exam1').classList.remove('active');
            document.getElementById('exam2').classList.remove('active');
            document.getElementById(`exam${examIndex}`).classList.add('active');
            document.getElementById('examTitle').textContent = exams[examIndex].name;
        }

        function registerStudent() {
            const name = document.getElementById('studentName').value.trim();
            const email = document.getElementById('studentEmail').value.trim();

            if (!name || !email) {
                alert('Completa todos los campos');
                return;
            }

            currentStudent = {
                name: name,
                email: email,
                attempts: [],
                currentAttempt: 1,
                maxAttempts: 3
            };

            document.getElementById('registrationForm').style.display = 'none';
            document.getElementById('examContent').style.display = 'block';
            
            resetAttempt();
            startTimer();
            renderQuestions();
        }

        function resetAttempt() {
            const exam = exams[currentExam];
            answers = new Array(exam.questions.length).fill(null);
            questionStatus = new Array(exam.questions.length).fill('pending');
            currentQuestion = 0;
            timeLeft = 3600;
            examFinished = false;
            
            updateNavigationButtons();
            updateProgress();
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            timer = setInterval(() => {
                if (!examFinished) {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) finishAttempt();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeLeft / 3600);
            const minutes = Math.floor((timeLeft % 3600) / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
        }

        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            const exam = exams[currentExam];
            
            exam.questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.id = `q${index}`;
                questionDiv.style.display = index === 0 ? 'block' : 'none';
                
                const isAnswered = questionStatus[index] !== 'pending';
                
                let optionsHtml = '';
                q.options.forEach((opt, optIndex) => {
                    const isSelected = answers[index] === optIndex;
                    const isCorrect = optIndex === q.correct;
                    let optionClass = 'option';
                    
                    if (isAnswered) {
                        if (isCorrect) optionClass += ' correct-answer';
                        else if (isSelected) optionClass += ' incorrect-answer';
                        optionClass += ' answered';
                    } else if (isSelected) {
                        optionClass += ' selected';
                    }
                    
                    optionsHtml += `
                        <label class="${optionClass}">
                            <input type="radio" name="q${index}" value="${optIndex}" 
                                ${isSelected ? 'checked' : ''} 
                                ${isAnswered ? 'disabled' : ''}
                                onchange="handleAnswer(${index}, ${optIndex})">
                            ${String.fromCharCode(65 + optIndex)}. ${opt}
                        </label>
                    `;
                });
                
                questionDiv.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Pregunta ${index+1}</div>
                        ${isAnswered ? 
                            `<div class="answered-badge">${questionStatus[index]==='correct'?'‚úì Correcta':'‚úó Incorrecta'}</div>` : 
                            `<div class="question-status">Esperando respuesta</div>`}
                    </div>
                    <div class="question-text">${index+1}. ${q.text}</div>
                    <div class="options">${optionsHtml}</div>
                    <div id="feedback-${index}" class="feedback-message">
                        ${isAnswered && questionStatus[index]==='incorrect' ? 
                            `<div class="feedback-incorrect">‚ùå Incorrecto. Correcta: ${String.fromCharCode(65+q.correct)}. ${q.explanation}</div>` : 
                            isAnswered && questionStatus[index]==='correct' ?
                            `<div class="feedback-correct">‚úì ¬°Correcto! ${q.explanation}</div>` : ''}
                    </div>
                `;
                
                container.appendChild(questionDiv);
            });
        }

        function handleAnswer(questionIndex, optionIndex) {
            if (questionStatus[questionIndex] !== 'pending' || examFinished) return;

            const exam = exams[currentExam];
            const isCorrect = optionIndex === exam.questions[questionIndex].correct;
            
            answers[questionIndex] = optionIndex;
            questionStatus[questionIndex] = isCorrect ? 'correct' : 'incorrect';
            
            updateQuestionDisplay(questionIndex);
            updateProgress();
        }

        function updateQuestionDisplay(questionIndex) {
            const questionDiv = document.getElementById(`q${questionIndex}`);
            if (!questionDiv) return;
            
            const exam = exams[currentExam];
            const q = exam.questions[questionIndex];
            
            const header = questionDiv.querySelector('.question-header');
            header.innerHTML = `
                <div class="question-number">Pregunta ${questionIndex+1}</div>
                <div class="answered-badge">${questionStatus[questionIndex]==='correct'?'‚úì Correcta':'‚úó Incorrecta'}</div>
            `;
            
            const options = questionDiv.querySelectorAll('.option');
            options.forEach((opt, idx) => {
                const radio = opt.querySelector('input');
                opt.classList.remove('selected', 'correct-answer', 'incorrect-answer', 'answered');
                
                if (idx === q.correct) opt.classList.add('correct-answer');
                else if (idx === answers[questionIndex]) opt.classList.add('incorrect-answer');
                
                opt.classList.add('answered');
                radio.disabled = true;
            });
            
            const feedback = document.getElementById(`feedback-${questionIndex}`);
            if (questionStatus[questionIndex] === 'incorrect') {
                feedback.innerHTML = `<div class="feedback-incorrect">‚ùå Incorrecto. Correcta: ${String.fromCharCode(65+q.correct)}. ${q.explanation}</div>`;
            } else {
                feedback.innerHTML = `<div class="feedback-correct">‚úì ¬°Correcto! ${q.explanation}</div>`;
            }
        }

        function nextQuestion() {
            const exam = exams[currentExam];
            if (currentQuestion < exam.questions.length - 1) {
                document.getElementById(`q${currentQuestion}`).style.display = 'none';
                currentQuestion++;
                document.getElementById(`q${currentQuestion}`).style.display = 'block';
                updateNavigationButtons();
            }
        }

        function prevQuestion() {
            if (currentQuestion > 0) {
                document.getElementById(`q${currentQuestion}`).style.display = 'none';
                currentQuestion--;
                document.getElementById(`q${currentQuestion}`).style.display = 'block';
                updateNavigationButtons();
            }
        }

        function updateNavigationButtons() {
            const exam = exams[currentExam];
            document.getElementById('prevBtn').disabled = currentQuestion === 0;
            document.getElementById('nextBtn').disabled = currentQuestion === exam.questions.length - 1;
        }

        function updateProgress() {
            const answered = questionStatus.filter(s => s !== 'pending').length;
            const exam = exams[currentExam];
            const progress = (answered / exam.questions.length) * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }

        function calculateResults() {
            const exam = exams[currentExam];
            let correct = 0, incorrect = 0, unanswered = 0;
            
            exam.questions.forEach((_, index) => {
                if (questionStatus[index] === 'correct') correct++;
                else if (questionStatus[index] === 'incorrect') incorrect++;
                else unanswered++;
            });

            return { correct, incorrect, unanswered };
        }

        async function finishAttempt() {
            examFinished = true;
            clearInterval(timer);
            
            const exam = exams[currentExam];
            const results = calculateResults();
            const totalScore = (results.correct / exam.questions.length * 100).toFixed(1);
            
            const attemptData = {
                examName: exam.name,
                attemptNumber: currentStudent.currentAttempt,
                date: new Date().toLocaleString(),
                timeUsed: formatTime(3600 - timeLeft),
                results: results,
                totalScore: totalScore
            };
            
            currentStudent.attempts.push(attemptData);
            
            await sendResultsByEmail(attemptData);
            showResults(attemptData);
        }

        async function sendResultsByEmail(attemptData) {
            const indicator = document.getElementById('savingIndicator');
            indicator.style.display = 'block';
            indicator.textContent = 'üìß Enviando...';

            try {
                await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templateId,
                    {
                        student_name: currentStudent.name,
                        student_email: currentStudent.email,
                        exam_name: exams[currentExam].name,
                        date: attemptData.date,
                        attempt_number: attemptData.attemptNumber,
                        score: attemptData.totalScore,
                        correct: attemptData.results.correct,
                        incorrect: attemptData.results.incorrect,
                        unanswered: attemptData.results.unanswered
                    }
                );
                
                indicator.textContent = '‚úì Enviado';
                indicator.style.backgroundColor = '#27ae60';
            } catch (error) {
                indicator.textContent = '‚úó Error';
                indicator.style.backgroundColor = '#e74c3c';
            }
            
            setTimeout(() => indicator.style.display = 'none', 3000);
        }

        function showResults(attemptData) {
            document.getElementById('modalAttemptNumber').textContent = attemptData.attemptNumber;
            document.getElementById('resultsContent').innerHTML = `
                <div class="result-item"><span class="result-label">Estudiante:</span> ${currentStudent.name}</div>
                <div class="result-item"><span class="result-label">Examen:</span> ${exams[currentExam].name}</div>
                <div class="result-item"><span class="result-label">Fecha:</span> ${attemptData.date}</div>
                <div class="result-item"><span class="result-label">Tiempo:</span> ${attemptData.timeUsed}</div>
                <div style="margin:20px 0; padding:20px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border-radius:10px;">
                    <h3>Puntuaci√≥n</h3>
                    <div style="font-size:48px; font-weight:bold;">${attemptData.totalScore}%</div>
                    <div>${attemptData.results.correct} correctas | ${attemptData.results.incorrect} incorrectas</div>
                </div>
            `;
            document.getElementById('resultsModal').style.display = 'flex';
        }

        function showHistory() {
            if (currentStudent.attempts.length === 0) {
                document.getElementById('historyContent').innerHTML = '<p>Sin intentos previos</p>';
            } else {
                document.getElementById('historyContent').innerHTML = currentStudent.attempts.map((a, i) => `
                    <div class="result-item">
                        <h4>Intento #${a.attemptNumber}</h4>
                        <p>${a.date}</p>
                        <p>Puntuaci√≥n: ${a.totalScore}%</p>
                        <p>Correctas: ${a.results.correct}</p>
                    </div>
                `).join('');
            }
            document.getElementById('historyModal').style.display = 'flex';
        }

        function formatTime(seconds) {
            const h = Math.floor(seconds/3600);
            const m = Math.floor((seconds%3600)/60);
            const s = seconds%60;
            return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        function closeModal() {
            document.getElementById('resultsModal').style.display = 'none';
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        function downloadResults() {
            const data = currentStudent.attempts[currentStudent.attempts.length-1];
            const content = `RESULTADOS\nEstudiante: ${currentStudent.name}\nExamen: ${exams[currentExam].name}\nPuntuaci√≥n: ${data.totalScore}%`;
            const blob = new Blob([content], {type: 'text/plain'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `resultados_${currentStudent.name}.txt`;
            a.click();
        }
    </script>
</body>
</html>
